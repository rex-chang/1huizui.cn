---
title: "通过ssh反向代理+跳板机访问内网机器"
date: 2018-05-17T11:12:12+08:00
draft: true
tags: ['net', 'linux']
categories: ["网络"]
---

闲来无事在家里整了台Linux服务器, 想在外网访问时发现电信光猫无法做端口映射, 于是用手头闲置的云服做了个跳板机.

> 本文参考了 https://www.cnblogs.com/kwongtai/p/6903420.html

使用到的ssh参数:
反向代理:
`ssh -fcNR`
正向代理:
`ssh -fcNL`
参数说明:

```bash

-f 后台执行ssh指令
-C 允许压缩数据
-N 不执行远程指令
-R 将远程主机(服务器)的某个端口转发到本地端指定机器的指定端口
-L 将本地机(客户机)的某个端口转发到远端指定机器的指定端口
-p 指定远程主机的端口

******************区分大小写啊各位亲******************
```


<!--more-->
### 1. 机器情况

| 机器  | 备注                    |
| :---- | :---------------------- |
| 机器A | 处于内网                |
| 机器B | 处于外网, 作为跳板机    |
| 机器C | 处于公司内网, 想要访问A |
|       |

### 2. 配置免密登录:

#### 2.1 机器A上生成密钥

```bash
ssh-keygen -t rsa
```

#### 2.2 将公钥拷贝到机器B上

```bash
ssh-copy-id -p[机器B的Port] [机器B用户名]@[机器B的IP]
```
 
### 3. 每台机器需要安装`ssh`客户端, 跳板机安装`openssh-server`

#### 3.1 在[A机器]上执行

```bash
ssh -fCNR [机器A的IP或省略]:[A机器端口]:[B机器的IP]:[B机器端口] [登陆B机器的用户名@B机器的IP] -p [B机Port]
```

如使用B机器的7280端口，以及A机器的22端口，按照上面的指令就是这样子的操作
`ssh -fCNR 7280:localhost:22 root@123.123.123.123`

由于ssh会因断网/超时等原因断开,因此更好的做法是使用`autossh`

``` bash
sudo apt install autossh
autossh -M 7281 -fCNR 7280:localhost:22 root@123.123.123.123
```

#### 3.2 建立B机器的正向代理，用来做转发，具体指令

```bash
ssh -fCNL [A机器IP或省略]:[A机器端口]:[B机器的IP]:[B机器端口] [登陆B机器的用户名@B机器的IP]
```
